 reload! && Agreement.accepted.last.pdf_file.delete && BuildAgreementPdfGroverWorker.new.perform(Agreement.accepted.last.id)
Reloading...
  Agreement Load (0.4ms)  SELECT "agreements".* FROM "agreements" WHERE "agreements"."status" = $1 ORDER BY "agreements"."id" DESC LIMIT $2  [["status", "accepted"], ["LIMIT", 1]]
  ActiveStorage::Attachment Load (0.4ms)  SELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."record_id" = $1 AND "active_storage_attachments"."record_type" = $2 AND "active_storage_attachments"."name" = $3 LIMIT $4  [["record_id", 57], ["record_type", "Agreement"], ["name", "pdf_file"], ["LIMIT", 1]]
  ActiveStorage::Attachment Destroy (1.2ms)  DELETE FROM "active_storage_attachments" WHERE "active_storage_attachments"."id" = $1  [["id", 543]]
  Agreement Load (0.3ms)  SELECT "agreements".* FROM "agreements" WHERE "agreements"."status" = $1 ORDER BY "agreements"."id" DESC LIMIT $2  [["status", "accepted"], ["LIMIT", 1]]
  Agreement Load (0.2ms)  SELECT "agreements".* FROM "agreements" WHERE "agreements"."id" = $1 LIMIT $2  [["id", 57], ["LIMIT", 1]]
Processing Agreement ID: 57
  Signatory Load (0.4ms)  SELECT "signatories".* FROM "signatories" WHERE "signatories"."signable_id" = $1 AND "signatories"."signable_type" = $2  [["signable_id", 57], ["signable_type", "Agreement"]]
  ActiveStorage::Attachment Load (0.4ms)  SELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."record_id" = $1 AND "active_storage_attachments"."record_type" = $2 AND "active_storage_attachments"."name" = $3 LIMIT $4  [["record_id", 57], ["record_type", "Agreement"], ["name", "pdf_file"], ["LIMIT", 1]]
--------------------------------
Attempt 1
Generated URL for PDF: http://localhost:3000/document-as-creator/doc-765887f5-1eb3-4cb2-9c4c-43abe7275b36-8f9fd36ea8bfb8?from=worker&hideForPdf=true&preview=true
  Certificate Load (0.3ms)  SELECT "certificates".* FROM "certificates" WHERE "certificates"."certifiable_id" = $1 AND "certificates"."certifiable_type" = $2 AND "certificates"."key_usage" = $3 LIMIT $4  [["certifiable_id", 57], ["certifiable_type", "Agreement"], ["key_usage", "agreement_certification"], ["LIMIT", 1]]
Generated PDF for Agreement ID: 57
Computed pdf_hash during signing (after adding metadata): 420a7d0923c0198227f41a330a36a4419c89aa4e96b4e0224397306562287777
Generated signature for Agreement ID: 57
Added metadata to PDF for Agreement ID: 57
  TRANSACTION (0.7ms)  BEGIN
  Foretag Load (0.7ms)  SELECT "foretags".* FROM "foretags" WHERE "foretags"."id" = $1 LIMIT $2  [["id", 90], ["LIMIT", 1]]
  TeamMember Load (0.2ms)  SELECT "team_members".* FROM "team_members" WHERE "team_members"."id" = $1 LIMIT $2  [["id", 134], ["LIMIT", 1]]
  TeamMember Load (0.2ms)  SELECT "team_members".* FROM "team_members" WHERE "team_members"."id" = $1 LIMIT $2  [["id", 134], ["LIMIT", 1]]
  Signatory Exists? (0.9ms)  SELECT 1 AS one FROM "signatories" WHERE "signatories"."signable_id" = $1 AND "signatories"."signable_type" = $2 AND "signatories"."customer_type" = $3 LIMIT $4  [["signable_id", 57], ["signable_type", "Agreement"], ["customer_type", "issuer"], ["LIMIT", 1]]
  ActiveStorage::Blob Load (0.4ms)  SELECT "active_storage_blobs".* FROM "active_storage_blobs" INNER JOIN "active_storage_attachments" ON "active_storage_blobs"."id" = "active_storage_attachments"."blob_id" WHERE "active_storage_attachments"."record_id" = $1 AND "active_storage_attachments"."record_type" = $2 AND "active_storage_attachments"."name" = $3 LIMIT $4  [["record_id", 57], ["record_type", "Agreement"], ["name", "pdf_file"], ["LIMIT", 1]]
  ActiveStorage::Blob Create (0.6ms)  INSERT INTO "active_storage_blobs" ("key", "filename", "content_type", "metadata", "byte_size", "checksum", "created_at", "service_name") VALUES ($1, $2, $3, $4, $5, $6, $7, $8) RETURNING "id"  [["key", "xro5zeps3xftajeml0nvr4j874ae"], ["filename", "agreement_doc-765887f5-1eb3-4cb2-9c4c-43abe7275b36-8f9fd36ea8bfb8.pdf"], ["content_type", "application/pdf"], ["metadata", "{\"identified\":true}"], ["byte_size", 329443], ["checksum", "vhKhYFpcS3gSZMwzCr1Xyw=="], ["created_at", "2024-12-13 17:20:12.366480"], ["service_name", "local"]]
  ActiveStorage::Attachment Create (0.4ms)  INSERT INTO "active_storage_attachments" ("name", "record_type", "record_id", "blob_id", "created_at", "position") VALUES ($1, $2, $3, $4, $5, $6) RETURNING "id"  [["name", "pdf_file"], ["record_type", "Agreement"], ["record_id", 57], ["blob_id", 593], ["created_at", "2024-12-13 17:20:12.367863"], ["position", 0]]
  Agreement Update (0.5ms)  UPDATE "agreements" SET "updated_at" = $1 WHERE "agreements"."id" = $2  [["updated_at", "2024-12-13 17:20:12.368916"], ["id", 57]]
  TRANSACTION (0.5ms)  COMMIT
  Disk Storage (1.9ms) Uploaded file to key: xro5zeps3xftajeml0nvr4j874ae (checksum: vhKhYFpcS3gSZMwzCr1Xyw==)
  TRANSACTION (0.2ms)  BEGIN
  ActiveStorage::Blob Update (1.1ms)  UPDATE "active_storage_blobs" SET "metadata" = $1 WHERE "active_storage_blobs"."id" = $2  [["metadata", "{\"identified\":true,\"analyzed\":true}"], ["id", 593]]
  ActiveStorage::Attachment Load (0.5ms)  SELECT "active_storage_attachments".* FROM "active_storage_attachments" WHERE "active_storage_attachments"."blob_id" = $1  [["blob_id", 593]]
  Agreement Load (0.2ms)  SELECT "agreements".* FROM "agreements" WHERE "agreements"."id" = $1  [["id", 57]]
  Agreement Update (0.5ms)  UPDATE "agreements" SET "updated_at" = $1 WHERE "agreements"."id" = $2  [["updated_at", "2024-12-13 17:20:12.377575"], ["id", 57]]
  TRANSACTION (0.3ms)  COMMIT
Attached secured PDF to Agreement ID: 57
ChangeLogger:
  TRANSACTION (0.1ms)  BEGIN
  Signatory Exists? (0.7ms)  SELECT 1 AS one FROM "signatories" WHERE "signatories"."signable_id" = $1 AND "signatories"."signable_type" = $2 AND "signatories"."customer_type" = $3 LIMIT $4  [["signable_id", 57], ["signable_type", "Agreement"], ["customer_type", "issuer"], ["LIMIT", 1]]
  Agreement Update (0.4ms)  UPDATE "agreements" SET "updated_at" = $1, "pdf_file_created_at" = $2 WHERE "agreements"."id" = $3  [["updated_at", "2024-12-13 17:20:12.380890"], ["pdf_file_created_at", "2024-12-13 17:20:12.378936"], ["id", 57]]
  PaperTrail::Version Create (0.6ms)  INSERT INTO "versions" ("whodunnit", "created_at", "item_id", "item_type", "event", "object", "ip", "user_agent", "user_email", "user_id") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10) RETURNING "id"  [["whodunnit", nil], ["created_at", "2024-12-13 17:20:12.380890"], ["item_id", 57], ["item_type", "Agreement"], ["event", "update"], ["object", "---\nid: 57\nname: Lars Larsson\nuuid: doc-765887f5-1eb3-4cb2-9c4c-43abe7275b36-8f9fd36ea8bfb8\nstatus: accepted\nsearch_query: lars larsson, sol och tak dalarna ab\nagreement_type: proposal\ncompany_name: Sol och Tak Dalarna AB\ncompany_organization_number: 123456-7890\ncompany_address: Torggatan 1, 784 44, Borlänge, Sverige\ncompany_zip_code: 784 44\ncompany_city: Borlänge\ncompany_country: Sverige\ncompany_email: info@solotak.se\ncompany_phone: '073919590'\ncompany_website:\nissuer_name: Mackan Göras\nissuer_email: mackan@solotak.se\nissuer_phone: \"+46739195910\"\nissuer_description:\nrecipient_address: Svenssons Väg 6, 15446 Lyckberg\nsent_at_date: 2024-12-13 15:40:33.563966000 +01:00\nvalid_until_date: 2025-01-12 15:40:00.000000000 +01:00\naccepted_at_date: 2024-12-13 15:44:33.633440000 +01:00\nnotification_method: email\nsigning_method: digital\nsigning_order: false\nsignatories_count: 2\nsent_to_signatories_count: 2\ntotal_amount:\ntotal_amount_includes_vat: false\ncurrency: sek\ndeclined_reason:\ndeclined_at_date:\nis_template: false\ntemplate_name:\ntemplate_description:\ntemplate_pinned: false\ntemplate_uses: 0\ntemplate_author_user_id:\nissued_by_team_member_id: 134\nupdated_by_team_member_id: 134\nforetag_id: 90\njob_cycle_id: 8\ncreated_at: 2024-12-13 15:40:17.060602000 +01:00\nupdated_at: 2024-12-13 17:20:12.368916000 +01:00\nfastighetsbeteckning:\npdf_file_created_at: 2024-12-13 16:53:13.240261000 +01:00\n"], ["ip", nil], ["user_agent", nil], ["user_email", nil], ["user_id", nil]]
  TRANSACTION (0.4ms)  COMMIT
PDF attached at URL: http://localhost:3000/rails/active_storage/blobs/redirect/eyJfcmFpbHMiOnsiZGF0YSI6NTkzLCJwdXIiOiJibG9iX2lkIn19--3cfc14e48ad6f0ee72edac9d004d76521b817ecb/agreement_doc-765887f5-1eb3-4cb2-9c4c-43abe7275b36-8f9fd36ea8bfb8.pdf
PDF Metadata Trailer: #<HexaPDF::Type::Info [1, 0] value={:Title=>"Lars Larsson", :Creator=>"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) HeadlessChrome/131.0.0.0 Safari/537.36", :Producer=>"HexaPDF version 1.0.3", :CreationDate=>"D:20200101000000+00'00'", :ModDate=>"D:20241213172012+01'00'", :SmartCertificateSerial=>"F64DD6CC316CEAE6E5F2BC44945B649B", :SmartIssuer=>"\xFE\xFF\x00M\x00a\x00c\x00k\x00a\x00n\x00 \x00G\x00\xF6\x00r\x00a\x00s\x00 \x00(\x00r\x00e\x00p\x00r\x00e\x00s\x00e\x00n\x00t\x00e\x00r\x00a\x00r\x00 \x00S\x00o\x00l\x00 \x00o\x00c\x00h\x00 \x00T\x00a\x00k\x00 \x00D\x00a\x00l\x00a\x00r\x00n\x00a\x00 \x00A\x00B\x00)", :SmartHash=>"420a7d0923c0198227f41a330a36a4419c89aa4e96b4e0224397306562287777", :SmartSignature=>"OC7F/Eyg6EEHRn7/HyQmXFRjkqpKYINraU0OZU+NNVSyxoJZ/ZXEtJKPqrtrjoF0/+g27nb4c1F8E9lKfKgTgHruCl1g93XFq9mvyWNlbsNXGCdeP7f8avAt3RNGlpU76WLgl8Enu45aMos952N+OYKcNc3qMW+W8wFy1nIKUdq3hBPSf/HOSAdCqHTROkgWnsLKN+hZ3tkBLPw1ZFBSGk0ub6YvuVA75+MlPtNFymHPkxNw9ziV6+gi+0BaCvecAM8BjtN2CZXuL/vG+6ZgTk7txOeRPRzw4ty17C5O3H2XAcjq3Jq3QGcCLDHimmzaF3Z8AriGG+lR5COQbFfeCQ==", :SmartSignedAt=>"2024-12-13T16:20:12Z"}>